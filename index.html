
<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Mural Final com GitHub API</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 1rem; background: #f2f2f2; }
    h1 { text-align: center; color: #003366; }
    .formulario, .painel { background: white; padding: 1rem; border-radius: 8px; margin: 1rem auto; max-width: 700px; box-shadow: 0 0 5px rgba(0,0,0,0.1); }
    input, textarea, select, button { width: 100%; padding: 0.5rem; margin-top: 0.5rem; border-radius: 4px; border: 1px solid #ccc; }
    button { background: #003366; color: white; font-weight: bold; margin-top: 1rem; cursor: pointer; }
    .noticia { background: white; margin: 1rem auto; padding: 1rem; max-width: 700px; border-radius: 8px; box-shadow: 0 0 4px rgba(0,0,0,0.1); }
    .noticia img { width: 100%; max-height: 200px; object-fit: cover; border-radius: 4px; }
    .sucesso { color: green; font-weight: bold; }
    .erro { color: red; font-weight: bold; }
    pre { background: #eee; padding: 1rem; border-radius: 8px; white-space: pre-wrap; font-size: 0.9rem; }
  </style>
</head>
<body>
  <h1>Mural de Notícias</h1>

  <div class="formulario" id="formulario">
    <h2>Nova Notícia</h2>
    <form id="formNoticias">
      <input type="text" id="titulo" placeholder="Título" required />
      <input type="text" id="preview" placeholder="Subtítulo / Preview" required />
      <input type="text" id="imagem" placeholder="URL da imagem" />
      <select id="categoria">
        <option>Marketing</option>
        <option>Audiovisuais</option>
        <option>Videojogos</option>
      </select>
      <textarea id="descricao" placeholder="Texto completo" rows="6" required></textarea>
      <input type="hidden" id="editId">
      <button type="submit">Guardar Notícia</button>
    </form>
  </div>

  <div id="noticias"></div>

  <div class="painel" id="githubPanel">
    <h2>Guardar no GitHub</h2>
    <input id="usuario" placeholder="Utilizador GitHub" />
    <input id="repositorio" placeholder="Repositório" />
    <input id="ficheiro" value="noticias.json" />
    <input id="token" type="password" placeholder="Token pessoal" />
    <button onclick="guardarNoGitHub()">Guardar no GitHub</button>
    <p id="mensagem" class=""></p>
    <pre id="jsonPreview"></pre>
  </div>

<script>
  let noticias = [];

  async function carregarNoticias() {
    try {
      const resp = await fetch('noticias.json');
      noticias = await resp.json();
    } catch {
      noticias = [];
    }
    renderNoticias();
  }

  function renderNoticias() {
    const div = document.getElementById("noticias");
    div.innerHTML = "";
    noticias.slice().reverse().forEach(n => {
      const card = document.createElement("div");
      card.className = "noticia";
      card.innerHTML = `
        <h2>${n.titulo}</h2>
        <h4>${n.preview || ''}</h4>
        ${n.imagem ? `<img src="${n.imagem}" alt="Imagem">` : ''}
        <p><small>${new Date(n.data).toLocaleDateString("pt-PT")}</small></p>
        <p>${n.descricao}</p>
      `;
      div.appendChild(card);
    });
    document.getElementById("jsonPreview").textContent = JSON.stringify(noticias, null, 2);
  }

  document.getElementById("formNoticias").addEventListener("submit", e => {
    e.preventDefault();
    const id = document.getElementById("editId").value || "_" + Math.random().toString(36).substr(2, 9);
    const noticia = {
      id,
      titulo: document.getElementById("titulo").value,
      preview: document.getElementById("preview").value,
      imagem: document.getElementById("imagem").value,
      categoria: document.getElementById("categoria").value,
      descricao: document.getElementById("descricao").value,
      data: new Date().toISOString()
    };
    noticias = noticias.filter(n => n.id !== id);
    noticias.push(noticia);
    document.getElementById("formNoticias").reset();
    document.getElementById("editId").value = "";
    renderNoticias();
  });

  async function guardarNoGitHub() {
    const mensagem = document.getElementById("mensagem");
    const username = document.getElementById("usuario").value;
    const repo = document.getElementById("repositorio").value;
    const path = document.getElementById("ficheiro").value;
    const token = document.getElementById("token").value;
    const url = `https://api.github.com/repos/${username}/${repo}/contents/${path}`;
    const content = btoa(unescape(encodeURIComponent(JSON.stringify(noticias, null, 2))));

    try {
      const getResp = await fetch(url, { headers: { Authorization: "token " + token }});
      const data = await getResp.json();
      const sha = data.sha;

      const res = await fetch(url, {
        method: "PUT",
        headers: {
          Authorization: "token " + token,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          message: "Atualizar noticias.json via mural",
          content,
          sha
        })
      });

      mensagem.className = res.ok ? "sucesso" : "erro";
      mensagem.textContent = res.ok ? "✅ Guardado com sucesso!" : "❌ Erro ao guardar.";
    } catch {
      mensagem.className = "erro";
      mensagem.textContent = "❌ Erro de rede ou API.";
    }
  }

  carregarNoticias();
</script>
</body>
</html>
