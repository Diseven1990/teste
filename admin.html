
<!DOCTYPE html>
<html lang="pt">
<head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Admin</title></head>
<body>
<h2>Criar Notícia</h2>
<input id="titulo" placeholder="Título"><input id="preview" placeholder="Subtítulo">
<select id="imagem"><option value="fotos/imagem1.jpg">imagem1.jpg</option><option value="fotos/imagem2.jpg">imagem2.jpg</option></select>
<select id="categoria"><option>Marketing</option><option>Audiovisuais</option><option>Videojogos</option></select>
<textarea id="descricao" rows="4" placeholder="Texto completo"></textarea>
<h3>GitHub Token</h3><input id="token" placeholder="GitHub Token">
<button onclick="guardarNoticia()">Guardar no GitHub</button><p id="msg"></p><pre id="debug"></pre>
<script>
async function guardarNoticia() {
  const repo = "diogo/mural-noticias", path = "noticias.json", token = document.getElementById("token").value;
  const noticia = {
    id: "_" + Math.random().toString(36).substr(2, 9),
    titulo: titulo.value, preview: preview.value, imagem: imagem.value,
    categoria: categoria.value, descricao: descricao.value, data: new Date().toISOString()
  };
  const msg = document.getElementById("msg"), debug = document.getElementById("debug");
  try {
    const res = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
      headers: { Authorization: "token " + token }
    });
    const data = await res.json();
    let noticias = data.content ? JSON.parse(atob(data.content)) : [];
    noticias.push(noticia);
    const updatedContent = btoa(unescape(encodeURIComponent(JSON.stringify(noticias, null, 2))));
    const response = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
      method: "PUT",
      headers: {
        Authorization: "token " + token,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ message: "Nova notícia", content: updatedContent, sha: data.sha })
    });
    msg.textContent = response.ok ? "✅ Notícia guardada!" : "❌ Erro ao guardar.";
    debug.textContent = JSON.stringify(await response.json(), null, 2);
  } catch (e) {
    msg.textContent = "❌ Erro inesperado."; debug.textContent = e.toString();
  }
}
</script>
</body>
</html>
